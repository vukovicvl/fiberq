name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Unit tests - no QGIS required
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests (Python only)

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --tb=short

  # QGIS integration tests
  qgis-tests:
    runs-on: ubuntu-latest
    name: QGIS Integration Tests

    strategy:
      matrix:
        qgis_version: ['3.28', '3.34']

    container:
      image: qgis/qgis:release-${{ matrix.qgis_version }}

    steps:
      - uses: actions/checkout@v4

      - name: Install test dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install pytest pytest-qgis pytest-cov

      - name: Run QGIS tests
        run: |
          xvfb-run -s '+extension GLX -screen 0 1024x768x24' \
            pytest tests/ -v --tb=short --qgis_disable_gui

  # Syntax check - quick validation
  syntax-check:
    runs-on: ubuntu-latest
    name: Python Syntax Check

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        run: |
          python -m py_compile fiberq/__init__.py
          python -m py_compile fiberq/main_plugin.py
          find fiberq/addons -name "*.py" -exec python -m py_compile {} \;
          echo "All Python files have valid syntax"

  # Code style check (optional)
  lint:
    runs-on: ubuntu-latest
    name: Code Style (flake8)
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8
        run: |
          flake8 fiberq/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 fiberq/ --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
